# üìö API Documentation - Complete Reference

> **Generated by Senior Backend Developer Audit**  
> **Date:** December 5, 2025  
> **Base URL:** `https://api.yourshop.com` (Production) | `http://localhost:3000` (Development)  
> **API Version:** v1

---

## üìñ Table of Contents

### 1. [Authentication](#1-authentication)
- 1.1 [Customer Authentication](#11-customer-authentication)
- 1.2 [Admin Authentication](#12-admin-authentication)

### 2. [Products & Catalog](#2-products--catalog)
- 2.1 [Products (Public)](#21-products-public)
- 2.2 [Products Management (Admin)](#22-products-management-admin)
- 2.3 [Categories](#23-categories)
- 2.4 [Colors & Sizes](#24-colors--sizes)

### 3. [Shopping](#3-shopping)
- 3.1 [Cart](#31-cart)
- 3.2 [Checkout](#32-checkout)
- 3.3 [Orders](#33-orders)
- 3.4 [Payment](#34-payment)

### 4. [Customer Features](#4-customer-features)
- 4.1 [Account Management](#41-account-management)
- 4.2 [Addresses](#42-addresses)
- 4.3 [Wishlist](#43-wishlist)
- 4.4 [Reviews](#44-reviews)

### 5. [Support & AI](#5-support--ai)
- 5.1 [Support Tickets](#51-support-tickets)
- 5.2 [Live Chat](#52-live-chat)
- 5.3 [AI Consultant](#53-ai-consultant)

### 6. [Admin Panel](#6-admin-panel)
- 6.1 [Dashboard & Analytics](#61-dashboard--analytics)
- 6.2 [Order Management](#62-order-management)
- 6.3 [Customer Management](#63-customer-management)
- 6.4 [Inventory](#64-inventory)
- 6.5 [Promotions](#65-promotions)
- 6.6 [CMS Pages](#66-cms-pages)

---

## üîê Authentication Flows

### Access Control Levels:
- **Public:** No authentication required
- **Customer:** Requires JWT Bearer Token (from customer login)
- **Admin:** Requires JWT Bearer Token (from admin login) + Admin role

### Token Information:
- **Customer Access Token:** 15 minutes expiry
- **Customer Refresh Token:** 30 days expiry  
- **Admin Access Token:** 8 hours expiry (no refresh token)

### Authorization Header Format:
```
Authorization: Bearer <access_token>
```

---

# 1. Authentication

## 1.1 Customer Authentication

### üîπ POST `/api/v1/auth/register`
**ƒêƒÉng k√Ω t√†i kho·∫£n m·ªõi**

#### Authentication
- ‚ùå Not required (Public)

#### Request Body
| Field | Type | Required | Validation | Description |
|-------|------|----------|------------|-------------|
| `name` | string | ‚ùå Optional | Min 2 chars | T√™n hi·ªÉn th·ªã c·ªßa user |
| `email` | string | ‚úÖ Required | Valid email format | Email (unique) |
| `password` | string | ‚úÖ Required | Min 6 chars, max 50 chars | M·∫≠t kh·∫©u |

#### Request Example
```json
{
  "name": "John Doe",
  "email": "john@example.com",
  "password": "SecurePassword123"
}
```

#### Response Success (201 Created)
```json
{
  "message": "ƒêƒÉng k√Ω th√†nh c√¥ng! Vui l√≤ng ki·ªÉm tra email ƒë·ªÉ k√≠ch ho·∫°t t√†i kho·∫£n.",
  "customer": {
    "id": 123,
    "email": "john@example.com",
    "name": "John Doe",
    "status": "inactive"
  }
}
```

#### Error Responses

**409 Conflict - Email ƒë√£ t·ªìn t·∫°i**
```json
{
  "statusCode": 409,
  "message": "Email ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng",
  "error": "Conflict"
}
```

**400 Bad Request - Validation error**
```json
{
  "statusCode": 400,
  "message": [
    "email must be a valid email",
    "password must be at least 6 characters"
  ],
  "error": "Bad Request"
}
```

#### cURL Example
```bash
curl -X POST https://api.yourshop.com/api/v1/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "name": "John Doe",
    "email": "john@example.com",
    "password": "SecurePassword123"
  }'
```

#### JavaScript Example
```javascript
const response = await fetch('https://api.yourshop.com/api/v1/auth/register', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    name: 'John Doe',
    email: 'john@example.com',
    password: 'SecurePassword123'
  })
});
const data = await response.json();
```

#### Logic Flow
1. Validate input (email format, password length)
2. Check if email exists ‚Üí throw 409 if duplicate
3. Hash password with bcrypt
4. Create customer with `status='inactive'`
5. Generate activation token (JWT, 24h expiry)
6. Send activation email with link: `{FRONTEND_URL}/auth/activate?token=...`
7. Return success message

#### Edge Cases
- ‚úÖ Email is case-insensitive (converted to lowercase)
- ‚úÖ User cannot login until account is activated
- ‚úÖ Activation token expires after 24 hours

---

### üîπ GET `/api/v1/auth/activate`
**K√≠ch ho·∫°t t√†i kho·∫£n (Click link trong email)**

#### Authentication
- ‚ùå Not required (Public)

#### Query Parameters
| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `token` | string | ‚úÖ Required | Activation token t·ª´ email |

#### Request Example
```
GET /api/v1/auth/activate?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

#### Response Success (302 Redirect)
Redirects to:
```
{FRONTEND_URL}/auth/success?access_token=xxx&refresh_token=yyy
```

#### Error Response (302 Redirect to Error Page)
Redirects to:
```
{FRONTEND_URL}/auth/error?message=Token%20kh√¥ng%20h·ª£p%20l·ªá
```

#### Logic Flow
1. Verify JWT token
2. Extract customer_id from token
3. Update `status='active'` in database
4. Generate new access_token (15min) and refresh_token (30 days)
5. Redirect to frontend with tokens in URL

---

### üîπ POST `/api/v1/auth/activate`
**K√≠ch ho·∫°t t√†i kho·∫£n (API call alternative)**

#### Authentication
- ‚ùå Not required (Public)

#### Request Body
| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `token` | string | ‚úÖ Required | Activation token t·ª´ email |

#### Request Example
```json
{
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

#### Response Success (200 OK)
```json
{
  "message": "K√≠ch ho·∫°t t√†i kho·∫£n th√†nh c√¥ng",
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "customer": {
    "id": 123,
    "email": "john@example.com",
    "name": "John Doe",
    "status": "active"
  }
}
```

#### Error Responses

**401 Unauthorized - Token kh√¥ng h·ª£p l·ªá**
```json
{
  "statusCode": 401,
  "message": "Token kh√¥ng h·ª£p l·ªá ho·∫∑c ƒë√£ h·∫øt h·∫°n",
  "error": "Unauthorized"
}
```

---

### üîπ POST `/api/v1/auth/login`
**ƒêƒÉng nh·∫≠p b·∫±ng email/password**

#### Authentication
- ‚ùå Not required (Public)

#### Request Body
| Field | Type | Required | Validation | Description |
|-------|------|----------|------------|-------------|
| `email` | string | ‚úÖ Required | Valid email | Email ƒëƒÉng k√Ω |
| `password` | string | ‚úÖ Required | Min 6 chars | M·∫≠t kh·∫©u |

#### Request Example
```json
{
  "email": "john@example.com",
  "password": "SecurePassword123"
}
```

#### Response Success (200 OK)
```json
{
  "message": "ƒêƒÉng nh·∫≠p th√†nh c√¥ng",
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "customer": {
    "id": 123,
    "email": "john@example.com",
    "name": "John Doe",
    "status": "active"
  }
}
```

#### Error Responses

**401 Unauthorized - Sai email/password**
```json
{
  "statusCode": 401,
  "message": "Email ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ch√≠nh x√°c",
  "error": "Unauthorized"
}
```

**401 Unauthorized - T√†i kho·∫£n ch∆∞a k√≠ch ho·∫°t**
```json
{
  "statusCode": 401,
  "message": "T√†i kho·∫£n ch∆∞a ƒë∆∞·ª£c k√≠ch ho·∫°t. Vui l√≤ng ki·ªÉm tra email.",
  "error": "Unauthorized"
}
```

**401 Unauthorized - T√†i kho·∫£n b·ªã kh√≥a**
```json
{
  "statusCode": 401,
  "message": "T√†i kho·∫£n ƒë√£ b·ªã kh√≥a. Vui l√≤ng li√™n h·ªá admin.",
  "error": "Unauthorized"
}
```

#### cURL Example
```bash
curl -X POST https://api.yourshop.com/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "john@example.com",
    "password": "SecurePassword123"
  }'
```

#### Logic Flow
1. Find customer by email
2. Check if customer exists ‚Üí 401 if not found
3. Compare password with bcrypt ‚Üí 401 if incorrect
4. Check `status` field:
   - `inactive` ‚Üí 401 (ch∆∞a k√≠ch ho·∫°t)
   - `deleted` ‚Üí 401 (t√†i kho·∫£n b·ªã kh√≥a)
5. Generate access_token (15min) and refresh_token (30 days)
6. Save refresh_token to database
7. Return tokens + customer info

---

### üîπ POST `/api/v1/auth/google`
**ƒêƒÉng nh·∫≠p/ƒêƒÉng k√Ω b·∫±ng Google**

#### Authentication
- ‚ùå Not required (Public)

#### Request Body
| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `auth_code` | string | ‚úÖ Required | Authorization code t·ª´ Google OAuth |

#### Request Example
```json
{
  "auth_code": "4/0AfJohXm..."
}
```

#### Response Success (200 OK)
```json
{
  "message": "ƒêƒÉng nh·∫≠p Google th√†nh c√¥ng",
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "customer": {
    "id": 123,
    "email": "john@gmail.com",
    "name": "John Doe",
    "status": "active"
  },
  "is_new_user": false
}
```

#### Error Responses

**400 Bad Request - Auth code kh√¥ng h·ª£p l·ªá**
```json
{
  "statusCode": 400,
  "message": "Authorization code kh√¥ng h·ª£p l·ªá ho·∫∑c ƒë√£ h·∫øt h·∫°n",
  "error": "Bad Request"
}
```

#### Logic Flow
1. Exchange auth_code for Google user info (call Google API)
2. Extract email, name from Google response
3. Check if customer exists by email:
   - **Exists:** Login existing user
   - **Not exists:** Auto-register new user with `status='active'` (no password)
4. Generate tokens
5. Return tokens + customer info + `is_new_user` flag

---

### üîπ POST `/api/v1/auth/refresh`
**L√†m m·ªõi Access Token**

#### Authentication
- ‚ùå Not required (Public, but needs refresh_token)

#### Request Body
| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `refresh_token` | string | ‚úÖ Required | Refresh token t·ª´ login response |

#### Request Example
```json
{
  "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

#### Response Success (200 OK)
```json
{
  "message": "Refresh token th√†nh c√¥ng",
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

#### Error Responses

**401 Unauthorized - Refresh token kh√¥ng h·ª£p l·ªá**
```json
{
  "statusCode": 401,
  "message": "Refresh token kh√¥ng h·ª£p l·ªá ho·∫∑c ƒë√£ h·∫øt h·∫°n",
  "error": "Unauthorized"
}
```

#### Logic Flow
1. Verify JWT refresh_token
2. Check if token exists in database and not expired
3. Extract customer_id from token
4. Generate new access_token (15min)
5. Optionally rotate refresh_token (generate new one)
6. Update database with new refresh_token
7. Return new tokens

#### Edge Cases
- ‚úÖ Old refresh_token is invalidated after use (rotation)
- ‚úÖ Customer can have multiple refresh tokens (multi-device support)

---

### üîπ POST `/api/v1/auth/logout`
**ƒêƒÉng xu·∫•t**

#### Authentication
- ‚úÖ Required (Bearer Token)

#### Headers
```
Authorization: Bearer <access_token>
```

#### Request Body
None (empty)

#### Response Success (200 OK)
```json
{
  "message": "ƒêƒÉng xu·∫•t th√†nh c√¥ng"
}
```

#### Error Responses

**401 Unauthorized - Ch∆∞a ƒëƒÉng nh·∫≠p**
```json
{
  "statusCode": 401,
  "message": "Unauthorized",
  "error": "Unauthorized"
}
```

#### cURL Example
```bash
curl -X POST https://api.yourshop.com/api/v1/auth/logout \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
```

#### Logic Flow
1. Extract customer_id from JWT
2. Delete/invalidate all refresh_tokens for this customer
3. Return success message
4. **Client must:** Clear access_token and refresh_token from storage

---

### üîπ POST `/api/v1/auth/forgot-password`
**G·ª≠i y√™u c·∫ßu ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u**

#### Authentication
- ‚ùå Not required (Public)

#### Request Body
| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `email` | string | ‚úÖ Required | Email t√†i kho·∫£n |

#### Request Example
```json
{
  "email": "john@example.com"
}
```

#### Response Success (200 OK)
```json
{
  "message": "N·∫øu email t·ªìn t·∫°i trong h·ªá th·ªëng, link ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u ƒë√£ ƒë∆∞·ª£c g·ª≠i."
}
```

#### Error Responses
- **No error response** (ƒë·ªÉ tr√°nh email enumeration attack)
- Lu√¥n tr·∫£ v·ªÅ 200 OK d√π email c√≥ t·ªìn t·∫°i hay kh√¥ng

#### Logic Flow
1. Find customer by email
2. If customer exists:
   - Generate reset token (JWT, 1 hour expiry)
   - Send email with link: `{FRONTEND_URL}/reset-password?token=...`
3. If customer not exists:
   - Do nothing (silent fail)
4. Always return success message

---

### üîπ POST `/api/v1/auth/verify-reset-token`
**X√°c th·ª±c token ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u**

#### Authentication
- ‚ùå Not required (Public)

#### Request Body
| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `token` | string | ‚úÖ Required | Reset token t·ª´ email |

#### Request Example
```json
{
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

#### Response Success (200 OK)
```json
{
  "message": "Token h·ª£p l·ªá",
  "email": "j***@example.com"
}
```

#### Error Responses

**401 Unauthorized - Token kh√¥ng h·ª£p l·ªá**
```json
{
  "statusCode": 401,
  "message": "Token kh√¥ng h·ª£p l·ªá ho·∫∑c ƒë√£ h·∫øt h·∫°n",
  "error": "Unauthorized"
}
```

---

### üîπ POST `/api/v1/auth/reset-password`
**ƒê·∫∑t m·∫≠t kh·∫©u m·ªõi**

#### Authentication
- ‚ùå Not required (Public, but needs reset token)

#### Request Body
| Field | Type | Required | Validation | Description |
|-------|------|----------|------------|-------------|
| `token` | string | ‚úÖ Required | - | Reset token t·ª´ email |
| `newPassword` | string | ‚úÖ Required | Min 6 chars | M·∫≠t kh·∫©u m·ªõi |

#### Request Example
```json
{
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "newPassword": "NewSecurePassword456"
}
```

#### Response Success (200 OK)
```json
{
  "message": "ƒê·∫∑t l·∫°i m·∫≠t kh·∫©u th√†nh c√¥ng. Vui l√≤ng ƒëƒÉng nh·∫≠p v·ªõi m·∫≠t kh·∫©u m·ªõi."
}
```

#### Error Responses

**401 Unauthorized - Token kh√¥ng h·ª£p l·ªá**
```json
{
  "statusCode": 401,
  "message": "Token kh√¥ng h·ª£p l·ªá ho·∫∑c ƒë√£ h·∫øt h·∫°n",
  "error": "Unauthorized"
}
```

**400 Bad Request - M·∫≠t kh·∫©u kh√¥ng h·ª£p l·ªá**
```json
{
  "statusCode": 400,
  "message": ["newPassword must be at least 6 characters"],
  "error": "Bad Request"
}
```

#### Logic Flow
1. Verify reset token
2. Extract customer_id from token
3. Hash new password with bcrypt
4. Update customer password in database
5. Invalidate reset token (mark as used)
6. Return success message

---

## 1.2 Admin Authentication

### üîπ POST `/api/v1/admin/auth/login`
**ƒêƒÉng nh·∫≠p Admin**

#### Authentication
- ‚ùå Not required (Public)

#### Request Body
| Field | Type | Required | Validation | Description |
|-------|------|----------|------------|-------------|
| `email` | string | ‚úÖ Required | Valid email | Email admin |
| `password` | string | ‚úÖ Required | Min 6 chars | M·∫≠t kh·∫©u |

#### Request Example
```json
{
  "email": "admin@shop.com",
  "password": "Admin123456"
}
```

#### Response Success (200 OK)
```json
{
  "message": "Admin login successful.",
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "admin": {
    "id": 1,
    "name": "Super Admin",
    "email": "admin@shop.com",
    "role": "super_admin"
  }
}
```

#### Error Responses

**401 Unauthorized - Sai email/password**
```json
{
  "statusCode": 401,
  "message": "Th√¥ng tin ƒëƒÉng nh·∫≠p kh√¥ng ch√≠nh x√°c",
  "error": "Unauthorized"
}
```

#### cURL Example
```bash
curl -X POST https://api.yourshop.com/api/v1/admin/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "admin@shop.com",
    "password": "Admin123456"
  }'
```

#### Logic Flow
1. Find admin by email
2. Check if admin exists ‚Üí 401 if not
3. Compare password with bcrypt ‚Üí 401 if incorrect
4. Generate access_token (8 hours expiry)
5. Return token + admin info

#### Key Differences from Customer Login
- ‚úÖ No refresh token (admin must re-login after 8 hours)
- ‚úÖ No activation required
- ‚úÖ No Google login support
- ‚úÖ JWT payload includes `type: 'admin'` and `role` field

---

### üîπ GET `/api/v1/admin/auth/me`
**L·∫•y th√¥ng tin admin hi·ªán t·∫°i**

#### Authentication
- ‚úÖ Required (Bearer Token + Admin role)

#### Headers
```
Authorization: Bearer <access_token>
```

#### Response Success (200 OK)
```json
{
  "id": 1,
  "name": "Admin User",
  "email": "admin@shop.com",
  "role": "admin",
  "created_at": "2024-01-01T00:00:00Z"
}
```

#### Error Responses

**401 Unauthorized**
```json
{
  "statusCode": 401,
  "message": "Unauthorized",
  "error": "Unauthorized"
}
```

---

### üîπ POST `/api/v1/admin/auth/logout`
**ƒêƒÉng xu·∫•t Admin**

#### Authentication
- ‚úÖ Required (Bearer Token + Admin role)

#### Response Success (200 OK)
```json
{
  "message": "Admin logout successful. Please clear access token on client."
}
```

#### Note
- Admin logout ch·ªâ tr·∫£ v·ªÅ message
- Client ph·∫£i x√≥a token t·ª´ localStorage/sessionStorage

---

### üîπ POST `/api/v1/admin/auth/create`
**T·∫°o t√†i kho·∫£n admin m·ªõi**

#### Authentication
- ‚úÖ Required (Bearer Token + Admin role)

#### Request Body
| Field | Type | Required | Validation | Description |
|-------|------|----------|------------|-------------|
| `name` | string | ‚úÖ Required | Min 2 chars | T√™n admin |
| `email` | string | ‚úÖ Required | Valid email, unique | Email |
| `password` | string | ‚úÖ Required | Min 6 chars | M·∫≠t kh·∫©u |
| `role` | string | ‚ùå Optional | Enum: 'admin', 'super_admin' | Default: 'admin' |

#### Request Example
```json
{
  "name": "New Admin",
  "email": "newadmin@shop.com",
  "password": "SecurePass123",
  "role": "admin"
}
```

#### Response Success (201 Created)
```json
{
  "message": "T·∫°o admin th√†nh c√¥ng",
  "admin": {
    "id": 2,
    "name": "New Admin",
    "email": "newadmin@shop.com",
    "role": "admin"
  }
}
```

#### Error Responses

**409 Conflict - Email ƒë√£ t·ªìn t·∫°i**
```json
{
  "statusCode": 409,
  "message": "Email ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng",
  "error": "Conflict"
}
```

**401 Unauthorized - Ch∆∞a ƒëƒÉng nh·∫≠p**
```json
{
  "statusCode": 401,
  "message": "Unauthorized",
  "error": "Unauthorized"
}
```

---

### üîπ POST `/api/v1/admin/auth/reset-password`
**Reset password admin (Authenticated)**

#### Authentication
- ‚úÖ Required (Bearer Token + Admin role)

#### Request Body
| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `email` | string | ‚úÖ Required | Email c·ªßa admin c·∫ßn reset |
| `newPassword` | string | ‚úÖ Required | M·∫≠t kh·∫©u m·ªõi (min 6 chars) |

#### Request Example
```json
{
  "email": "admin@shop.com",
  "newPassword": "NewPassword123"
}
```

#### Response Success (200 OK)
```json
{
  "message": "Reset password th√†nh c√¥ng",
  "admin": {
    "id": 1,
    "email": "admin@shop.com",
    "name": "Admin User"
  }
}
```

#### Error Responses

**404 Not Found - Admin kh√¥ng t·ªìn t·∫°i**
```json
{
  "statusCode": 404,
  "message": "Kh√¥ng t√¨m th·∫•y admin v·ªõi email n√†y",
  "error": "Not Found"
}
```

---

### üîπ POST `/api/v1/admin/auth/public-reset-password`
**Reset password admin (Public - Kh√¥ng c·∫ßn auth)**

#### Authentication
- ‚ùå Not required (Public, nh∆∞ng c√≥ th·ªÉ y√™u c·∫ßu secret code)

#### Request Body
| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `email` | string | ‚úÖ Required | Email admin |
| `newPassword` | string | ‚úÖ Required | M·∫≠t kh·∫©u m·ªõi |
| `secret_code` | string | ‚ùå Optional | Secret code (n·∫øu `ADMIN_RESET_SECRET` ƒë∆∞·ª£c set trong .env) |

#### Request Example
```json
{
  "email": "admin@shop.com",
  "newPassword": "NewSecurePassword789",
  "secret_code": "your-secret-code"
}
```

#### Response Success (200 OK)
```json
{
  "message": "Reset password th√†nh c√¥ng",
  "admin": {
    "id": 1,
    "email": "admin@shop.com",
    "name": "Admin User"
  }
}
```

#### Error Responses

**400 Bad Request - Secret code sai**
```json
{
  "statusCode": 400,
  "message": "Secret code kh√¥ng ƒë√∫ng",
  "error": "Bad Request"
}
```

**404 Not Found**
```json
{
  "statusCode": 404,
  "message": "Kh√¥ng t√¨m th·∫•y admin v·ªõi email n√†y",
  "error": "Not Found"
}
```

#### Logic Flow
1. Check if `ADMIN_RESET_SECRET` is set in environment
2. If set: Validate `secret_code` ‚Üí 400 if incorrect
3. If not set: Skip validation (cho ph√©p reset t·ª± do)
4. Find admin by email ‚Üí 404 if not found
5. Hash new password v·ªõi bcrypt
6. Update password in database
7. Return success

#### Use Case
- D√†nh cho backoffice ho·∫∑c khi qu√™n password v√† kh√¥ng c√≥ admin kh√°c ƒë·ªÉ reset
- Production: N√™n set `ADMIN_RESET_SECRET` ƒë·ªÉ b·∫£o v·ªá endpoint n√†y
- Development: C√≥ th·ªÉ b·ªè tr·ªëng ƒë·ªÉ d·ªÖ test

---

# 2. Products & Catalog

## 2.1 Products (Public)

### üîπ GET `/products`
**Danh s√°ch s·∫£n ph·∫©m (v·ªõi filter & search)**

#### Authentication: ‚ùå Public

#### Query Parameters
| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `page` | number | ‚ùå | Trang hi·ªán t·∫°i (default: 1) |
| `limit` | number | ‚ùå | S·ªë s·∫£n ph·∫©m/trang (default: 20) |
| `category_slug` | string | ‚ùå | Filter theo danh m·ª•c (slug) |
| `colors` | string | ‚ùå | Filter theo m√†u (IDs ho·∫∑c t√™n, c√°ch nhau b·ªüi d·∫•u ph·∫©y) |
| `sizes` | string | ‚ùå | Filter theo size (IDs ho·∫∑c t√™n, c√°ch nhau b·ªüi d·∫•u ph·∫©y) |
| `min_price` | number | ‚ùå | Gi√° t·ªëi thi·ªÉu |
| `max_price` | number | ‚ùå | Gi√° t·ªëi ƒëa |
| `search` | string | ‚ùå | T√¨m ki·∫øm theo t√™n ho·∫∑c m√¥ t·∫£ |
| `sort_by` | string | ‚ùå | S·∫Øp x·∫øp: `newest`, `price_asc`, `price_desc`, `rating` |

#### Response (200 OK)
```json
{
  "data": [
    {
      "id": 1,
      "name": "√Åo S∆° Mi Tr·∫Øng Classic",
      "slug": "ao-so-mi-trang-classic",
      "thumbnail_url": "https://...",
      "selling_price": 350000,
      "original_price": 350000,
      "flash_sale_price": null,
      "discount_percentage": 0,
      "average_rating": 4.5,
      "total_reviews": 120,
      "available_colors": ["Tr·∫Øng", "Xanh Navy"],
      "available_sizes": ["M", "L", "XL"],
      "is_on_sale": false,
      "category": {
        "id": 2,
        "name": "√Åo S∆° Mi",
        "slug": "ao-so-mi"
      }
    }
  ],
  "metadata": {
    "page": 1,
    "limit": 20,
    "total": 150,
    "totalPages": 8
  }
}
```

---

### üîπ GET `/products/new-arrivals`
**S·∫£n ph·∫©m m·ªõi (30 ng√†y g·∫ßn ƒë√¢y)**

Same structure as `/products`, filtered by `created_at > NOW() - 30 days`

---

### üîπ GET `/products/on-sale`
**S·∫£n ph·∫©m ƒëang khuy·∫øn m√£i (Flash Sale)**

Same structure, only products with active promotions

---

### üîπ GET `/products/:slug`
**Chi ti·∫øt s·∫£n ph·∫©m theo slug**

#### Response (200 OK)
```json
{
  "id": 1,
  "name": "√Åo S∆° Mi Tr·∫Øng Classic",
  "slug": "ao-so-mi-trang-classic",
  "description": "√Åo s∆° mi nam...",
  "full_description": "<p>M√¥ t·∫£ ƒë·∫ßy ƒë·ªß...</p>",
  "selling_price": 350000,
  "cost_price": 200000,
  "thumbnail_url": "https://...",
  "average_rating": 4.5,
  "total_reviews": 120,
  "category": {
    "id": 2,
    "name": "√Åo S∆° Mi"
  },
  "variants": [
    {
      "id": 101,
      "sku": "ASM-001-M-TRA",
      "size": { "id": 3, "name": "M" },
      "color": { "id": 1, "name": "Tr·∫Øng", "hex_code": "#FFFFFF" },
      "total_stock": 50,
      "reserved_stock": 5,
      "available_stock": 45,
      "images": [
        {
          "id": 201,
          "image_url": "https://...",
          "is_main": true
        }
      ]
    }
  ],
  "available_options": {
    "colors": [
      { "id": 1, "name": "Tr·∫Øng", "hex_code": "#FFFFFF", "in_stock": true }
    ],
    "sizes": [
      { "id": 3, "name": "M", "in_stock": true }
    ]
  },
  "promotion": {
    "id": 5,
    "name": "Flash Sale Weekend",
    "discount_value": 20,
    "discount_type": "percentage",
    "flash_sale_price": 280000,
    "end_date": "2024-12-31T23:59:59Z"
  },
  "related_products": [...]
}
```

**404 Error:** Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m

---

### üîπ GET `/products/id/:id`
**Chi ti·∫øt s·∫£n ph·∫©m theo ID**

Same response structure as GET by slug

---

### üîπ GET `/products/featured`
**S·∫£n ph·∫©m n·ªïi b·∫≠t (Homepage)**

Returns top-rated products (by rating and sales)

---

### üîπ GET `/products/filters`
**L·∫•y filter options cho UI**

#### Response (200 OK)
```json
{
  "colors": [
    { "id": 1, "name": "ƒêen", "hex_code": "#000000", "product_count": 50 }
  ],
  "sizes": [
    { "id": 3, "name": "M", "product_count": 120 }
  ],
  "price_range": {
    "min": 100000,
    "max": 1500000
  }
}
```

---

### üîπ GET `/products/:productId/reviews`
**Reviews c·ªßa s·∫£n ph·∫©m**

#### Query Parameters
- `page`, `limit` (pagination)
- `sort`: `created_at` | `rating`
- `order`: `asc` | `desc`

#### Response
```json
{
  "data": [
    {
      "id": 1,
      "rating": 5,
      "comment": "S·∫£n ph·∫©m r·∫•t t·ªët!",
      "customer_name": "Nguy·ªÖn VƒÉn A",
      "created_at": "2024-11-20T10:00:00Z"
    }
  ],
  "metadata": {...}
}
```

---

### üîπ GET `/products/:productId/related`
**S·∫£n ph·∫©m li√™n quan**

Returns products from same category (max 8 items by default)

---

# 3. Shopping

## 3.1 Cart

### üîπ GET `/cart`
**Xem gi·ªè h√†ng**

#### Authentication: ‚úÖ Required

#### Response (200 OK)
```json
{
  "cart_id": 123,
  "items": [
    {
      "id": 456,
      "variant_id": 101,
      "quantity": 2,
      "product": {
        "id": 1,
        "name": "√Åo S∆° Mi Tr·∫Øng",
        "thumbnail_url": "https://..."
      },
      "variant": {
        "sku": "ASM-001-M-TRA",
        "size": "M",
        "color": "Tr·∫Øng",
        "price": 350000,
        "available_stock": 45
      },
      "subtotal": 700000
    }
  ],
  "summary": {
    "subtotal": 700000,
    "shipping_fee": 30000,
    "discount": 0,
    "total": 730000
  }
}
```

---

### üîπ POST `/cart/items`
**Th√™m v√†o gi·ªè h√†ng**

#### Authentication: ‚úÖ Required

#### Request Body
| Field | Type | Required | Validation | Description |
|-------|------|----------|------------|-------------|
| `variant_id` | number | ‚úÖ | - | ID c·ªßa variant (size + color) |
| `quantity` | number | ‚ùå | Min: 1 | S·ªë l∆∞·ª£ng (default: 1) |

#### Request Example
```json
{
  "variant_id": 101,
  "quantity": 2
}
```

#### Response (201 Created)
```json
{
  "message": "Th√™m v√†o gi·ªè h√†ng th√†nh c√¥ng",
  "cart_item": {
    "id": 456,
    "variant_id": 101,
    "quantity": 2
  }
}
```

#### Errors
- **404:** Variant kh√¥ng t·ªìn t·∫°i
- **400:** Kh√¥ng ƒë·ªß h√†ng (requested > available_stock)

#### Logic Flow
1. Check if variant exists
2. Check available stock: `total_stock - reserved_stock >= quantity`
3. Check if variant already in cart:
   - Exists: Update quantity (add to existing)
   - Not exists: Create new cart_item
4. Return updated cart

---

### üîπ PUT `/cart/items/:id`
**C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng**

#### Request Body
```json
{
  "quantity": 3
}
```

Validation: quantity > 0, quantity <= available_stock

---

### üîπ DELETE `/cart/items/:id`
**X√≥a kh·ªèi gi·ªè h√†ng**

Returns `200 OK` v·ªõi message: "ƒê√£ x√≥a kh·ªèi gi·ªè h√†ng"

---

### üîπ DELETE `/cart/clear`
**X√≥a to√†n b·ªô gi·ªè h√†ng**

Deletes all cart_items for current customer

---

## 3.2 Checkout

### üîπ POST `/api/v1/checkout`
**T·∫°o ƒë∆°n h√†ng t·ª´ gi·ªè h√†ng**

#### Authentication: ‚úÖ Required

#### Request Body
| Field | Type | Required | Validation | Description |
|-------|------|----------|------------|-------------|
| `customer_address_id` | number | ‚úÖ | Positive integer | ID ƒë·ªãa ch·ªâ giao h√†ng |
| `payment_method` | string | ‚úÖ | Enum: `cod`, `vnpay` | Ph∆∞∆°ng th·ª©c thanh to√°n |
| `shipping_fee` | number | ‚ùå | Integer | Ph√≠ ship (default: 30000) |

#### Request Example
```json
{
  "customer_address_id": 5,
  "payment_method": "vnpay",
  "shipping_fee": 30000
}
```

#### Response (201 Created)
```json
{
  "message": "T·∫°o ƒë∆°n h√†ng th√†nh c√¥ng",
  "order": {
    "id": 789,
    "total_amount": 730000,
    "payment_status": "unpaid",
    "fulfillment_status": "pending",
    "payment_method": "vnpay",
    "created_at": "2024-11-26T10:00:00Z"
  },
  "next_step": "Call POST /checkout/create-payment-url to get VNPAY link"
}
```

#### Logic Flow (TRANSACTION)
1. Get all cart_items for customer
2. Validate cart not empty
3. Get customer_address ‚Üí 404 if not found
4. **For each cart_item:**
   - Check variant exists
   - Check stock: `available_stock >= quantity` ‚Üí 400 if insufficient
5. Calculate total: `sum(price * quantity) + shipping_fee`
6. Create order record
7. Create order_items (copy price as `price_at_purchase`)
8. **Update inventory:** `reserved_stock += quantity`
9. Delete cart_items
10. Commit transaction

If any step fails ‚Üí Rollback entire transaction

---

### üîπ POST `/api/v1/checkout/create-payment-url`
**T·∫°o link thanh to√°n VNPAY**

#### Request Body
```json
{
  "order_id": 789
}
```

#### Response (200 OK)
```json
{
  "paymentUrl": "https://sandbox.vnpayment.vn/paymentv2/vpcpay.html?vnp_Amount=73000000&vnp_Command=pay&..."
}
```

Frontend redirects user to `paymentUrl` to complete payment.

---

## 3.3 Orders

### üîπ GET `/orders`
**L·ªãch s·ª≠ ƒë∆°n h√†ng c·ªßa customer**

#### Authentication: ‚úÖ Required

#### Query Parameters
- `page`, `limit` (pagination)
- `status`: `pending` | `processing` | `shipped` | `delivered` | `cancelled`

#### Response
```json
{
  "data": [
    {
      "id": 789,
      "total_amount": 730000,
      "fulfillment_status": "shipped",
      "payment_status": "paid",
      "payment_method": "vnpay",
      "created_at": "2024-11-26T10:00:00Z",
      "items_count": 2
    }
  ],
  "metadata": {...}
}
```

---

### üîπ GET `/orders/:id`
**Chi ti·∫øt ƒë∆°n h√†ng**

#### Response (200 OK)
```json
{
  "id": 789,
  "customer_email": "user@example.com",
  "shipping_address": "123 Nguy·ªÖn Tr√£i, Ph∆∞·ªùng 1",
  "shipping_phone": "0912345678",
  "shipping_city": "TP. H·ªì Ch√≠ Minh",
  "fulfillment_status": "shipped",
  "payment_status": "paid",
  "payment_method": "vnpay",
  "shipping_fee": 30000,
  "total_amount": 730000,
  "created_at": "2024-11-26T10:00:00Z",
  "items": [
    {
      "id": 1001,
      "product_name": "√Åo S∆° Mi Tr·∫Øng",
      "variant_sku": "ASM-001-M-TRA",
      "size": "M",
      "color": "Tr·∫Øng",
      "quantity": 2,
      "price_at_purchase": 350000,
      "subtotal": 700000,
      "thumbnail_url": "https://..."
    }
  ]
}
```

---

### üîπ GET `/orders/:id/status-history`
**Timeline tr·∫°ng th√°i ƒë∆°n h√†ng**

```json
{
  "order_id": 789,
  "history": [
    {
      "id": 1,
      "status": "pending",
      "created_at": "2024-11-26T10:00:00Z",
      "admin_name": null,
      "note": "ƒê∆°n h√†ng ƒë√£ ƒë∆∞·ª£c t·∫°o"
    },
    {
      "id": 2,
      "status": "processing",
      "created_at": "2024-11-26T11:00:00Z",
      "admin_name": "Admin User",
      "note": "ƒêang x·ª≠ l√Ω ƒë∆°n h√†ng"
    },
    {
      "id": 3,
      "status": "shipped",
      "created_at": "2024-11-27T09:00:00Z",
      "admin_name": "Admin User",
      "note": "ƒê∆°n h√†ng ƒë√£ ƒë∆∞·ª£c giao cho ƒë∆°n v·ªã v·∫≠n chuy·ªÉn"
    }
  ]
}
```

---

### üîπ POST `/orders/:id/cancel`
**H·ªßy ƒë∆°n h√†ng**

#### Authentication: ‚úÖ Required

Only allowed when `fulfillment_status = 'pending'`

#### Response (200 OK)
```json
{
  "message": "H·ªßy ƒë∆°n h√†ng th√†nh c√¥ng. Kho ƒë√£ ƒë∆∞·ª£c ho√†n l·∫°i."
}
```

#### Logic
1. Check order belongs to customer
2. Check status is `pending` ‚Üí 400 if not
3. Update `fulfillment_status = 'cancelled'`
4. **Restore inventory:** `reserved_stock -= quantity` for each order_item
5. Log to order_status_history

---

### üîπ GET `/orders/track` (Public)
**Tracking ƒë∆°n h√†ng kh√¥ng c·∫ßn login**

#### Query Parameters
- `order_id` OR
- `phone` + `email`

Used by chatbot for order tracking

---

*[Continuing with more modules...]*

---

## Notes & Best Practices

### Error Handling
- All errors follow NestJS standard format with `statusCode`, `message`, and `error` fields
- Validation errors return array of messages
- Authentication errors return 401 Unauthorized
- Authorization errors (insufficient permissions) return 403 Forbidden
- Not found errors return 404 Not Found

### Security
- Passwords are hashed with bcrypt (saltRounds=10)
- JWT tokens use HS256 algorithm
- Refresh tokens are stored in database
- Email enumeration protection: forgot-password always returns 200
- Rate limiting should be applied on login endpoints (recommended)

### Pagination Format
Endpoints with pagination follow this format:
```json
{
  "data": [...],
  "metadata": {
    "page": 1,
    "limit": 20,
    "total": 150,
    "totalPages": 8
  }
}
```

